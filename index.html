<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Verge Script Converter (Web Demo)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .editor { font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; }
    </style>
</head>
<body class="p-6">

<div class="max-w-7xl mx-auto bg-white rounded-lg shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-2 text-gray-800">ğŸ› ï¸ Clash é…ç½®è½¬æ¢å™¨ (Verge è„šæœ¬ç‰ˆ)</h1>
    <p class="text-sm text-gray-600 mb-6">
        æ­¤å·¥å…·ç”¨äºåœ¨æµè§ˆå™¨ç«¯æ¨¡æ‹Ÿ Clash Verge çš„è„šæœ¬å¤„ç†åŠŸèƒ½ã€‚ä½ å¯ä»¥å¯¼å…¥åŸå§‹è®¢é˜…ï¼Œåº”ç”¨ JS è„šæœ¬ï¼Œç„¶åå¯¼å‡ºå¤„ç†åçš„ YAML ç»™ä¸æ”¯æŒè„šæœ¬çš„å®¢æˆ·ç«¯ï¼ˆå¦‚ Android/è·¯ç”±å™¨ï¼‰ä½¿ç”¨ã€‚
    </p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <div class="flex flex-col h-[600px]">
            <h2 class="font-semibold mb-2 flex justify-between items-center">
                1. åŸå§‹è®¢é˜… (YAML)
                <button onclick="fetchUrl()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200">ä»é“¾æ¥ä¸‹è½½</button>
            </h2>
            <input type="text" id="subUrl" placeholder="ç²˜è´´è®¢é˜…é“¾æ¥ (å¯èƒ½ä¼šæœ‰è·¨åŸŸé—®é¢˜)" class="mb-2 p-2 border rounded text-xs hidden">
            <textarea id="inputYaml" class="editor flex-1 border border-gray-300 rounded p-2 bg-gray-50 focus:outline-none focus:border-blue-500" placeholder="åœ¨æ­¤ç²˜è´´ Clash è®¢é˜…çš„åŸå§‹å†…å®¹..."></textarea>
        </div>

        <div class="flex flex-col h-[600px]">
            <h2 class="font-semibold mb-2">2. Verge æ‰©å±•è„šæœ¬ (Javascript)</h2>
            <textarea id="scriptJs" class="editor flex-1 border border-gray-300 rounded p-2 bg-gray-900 text-green-400 focus:outline-none focus:border-blue-500" spellcheck="false">// Clash Verge é£æ ¼è„šæœ¬
// å¿…é¡»åŒ…å« main å‡½æ•°

function main(config) {
  // ç¤ºä¾‹ï¼šä¿®æ”¹æ—¥å¿—çº§åˆ«
  config['log-level'] = 'info';

  // ç¤ºä¾‹ï¼šç»™æ‰€æœ‰ä»£ç†ç»„å¢åŠ ä¸€ä¸ª DIRECT é€‰é¡¹
  if (config['proxy-groups']) {
    config['proxy-groups'].forEach(group => {
       if(!group.proxies.includes('DIRECT')) {
           group.proxies.push('DIRECT');
       }
    });
  }

  // ç¤ºä¾‹ï¼šè¿‡æ»¤èŠ‚ç‚¹ (ä¿ç•™åŒ…å« 'é¦™æ¸¯' çš„èŠ‚ç‚¹)
  // const proxies = config.proxies || [];
  // config.proxies = proxies.filter(p => p.name.includes('é¦™æ¸¯'));

  return config;
}</textarea>
            <button onclick="processConfig()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded shadow transition">
                âš¡ æ‰§è¡Œå¤„ç†
            </button>
        </div>

        <div class="flex flex-col h-[600px]">
            <h2 class="font-semibold mb-2">3. ç»“æœè¾“å‡º (Standard YAML)</h2>
            <textarea id="outputYaml" class="editor flex-1 border border-gray-300 rounded p-2 bg-gray-50 focus:outline-none" readonly placeholder="ç‚¹å‡»æ‰§è¡Œå¤„ç†åï¼Œç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
            <div class="flex gap-2 mt-4">
                <button onclick="copyOutput()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded shadow text-sm">
                    ğŸ“‹ å¤åˆ¶ç»“æœ
                </button>
                <button onclick="downloadOutput()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded shadow text-sm">
                    ğŸ’¾ ä¸‹è½½æ–‡ä»¶
                </button>
            </div>
        </div>
    </div>
    
    <div id="statusMsg" class="mt-4 text-center text-sm font-medium text-gray-500"></div>
</div>

<script>
    // æ¨¡æ‹Ÿä» URL è·å– (ä½¿ç”¨å…¬å…± CORS ä»£ç†ï¼Œå¯èƒ½ä¸ç¨³å®š)
    async function fetchUrl() {
        const url = prompt("è¯·è¾“å…¥è®¢é˜…é“¾æ¥ï¼š\næ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶(CORS)ï¼Œç›´æ¥è¾“å…¥é“¾æ¥å¯èƒ½å¤±è´¥ã€‚\nå»ºè®®ç›´æ¥åœ¨å·¦ä¾§ç²˜è´´æ–‡æœ¬ã€‚");
        if (!url) return;
        
        showStatus("æ­£åœ¨ä¸‹è½½...", "text-blue-500");
        try {
            // ä½¿ç”¨ corsproxy.io ç»•è¿‡æµè§ˆå™¨è·¨åŸŸé™åˆ¶
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("ä¸‹è½½å¤±è´¥");
            const text = await response.text();
            document.getElementById('inputYaml').value = text;
            showStatus("ä¸‹è½½æˆåŠŸï¼", "text-green-500");
        } catch (e) {
            alert("ä¸‹è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶è®¢é˜…å†…å®¹åˆ°å·¦ä¾§æ–‡æœ¬æ¡†ã€‚\né”™è¯¯ä¿¡æ¯: " + e.message);
            showStatus("ä¸‹è½½å¤±è´¥", "text-red-500");
        }
    }

    function processConfig() {
        const yamlText = document.getElementById('inputYaml').value;
        const scriptText = document.getElementById('scriptJs').value;
        const statusEl = document.getElementById('statusMsg');

        if (!yamlText.trim()) {
            alert("è¯·å…ˆè¾“å…¥åŸå§‹ YAML é…ç½®");
            return;
        }

        try {
            showStatus("æ­£åœ¨è§£æ YAML...", "text-blue-500");
            // 1. è§£æ YAML
            let config = jsyaml.load(yamlText);

            showStatus("æ­£åœ¨æ‰§è¡Œè„šæœ¬...", "text-blue-500");
            
            // 2. æ„é€ è„šæœ¬æ‰§è¡Œç¯å¢ƒ
            // æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Functionï¼ŒæŠŠç”¨æˆ·çš„ä»£ç åŒ…è£¹è¿›å»ï¼Œå¹¶å°è¯•æå– main å‡½æ•°
            // è¿™ç§æ–¹å¼æ¯”è¾ƒ hackï¼Œä½†å¯¹äºç®€å•çš„ verge è„šæœ¬é€šå¸¸æœ‰æ•ˆ
            const userScriptWrapper = new Function(`
                ${scriptText}
                if (typeof main === 'function') {
                    return main;
                } else {
                    throw new Error("è„šæœ¬ä¸­æœªæ‰¾åˆ° function main(config) {...}");
                }
            `);

            const mainFunc = userScriptWrapper();
            
            // 3. æ‰§è¡Œç”¨æˆ·è„šæœ¬
            const newConfig = mainFunc(config);

            if (!newConfig) {
                throw new Error("è„šæœ¬æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ²¡æœ‰è¿”å› config å¯¹è±¡ (return config ä¸¢å¤±?)");
            }

            showStatus("æ­£åœ¨ç”Ÿæˆ YAML...", "text-blue-500");
            // 4. è½¬æ¢å› YAML
            const newYaml = jsyaml.dump(newConfig, {
                lineWidth: -1, // ä¸æŠ˜è¡Œ
                noRefs: true,  // ç¦ç”¨å¼•ç”¨ï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
                quotingType: '"'
            });

            document.getElementById('outputYaml').value = newYaml;
            showStatus("âœ… å¤„ç†æˆåŠŸï¼", "text-green-600");

        } catch (e) {
            console.error(e);
            alert("å¤„ç†å‡ºé”™:\n" + e.message);
            showStatus("âŒ å‘ç”Ÿé”™è¯¯: " + e.message, "text-red-600");
        }
    }

    function copyOutput() {
        const output = document.getElementById('outputYaml');
        output.select();
        document.execCommand('copy');
        showStatus("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "text-green-600");
    }

    function downloadOutput() {
        const text = document.getElementById('outputYaml').value;
        if(!text) return;
        const blob = new Blob([text], { type: "text/yaml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "processed_config.yaml";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function showStatus(msg, colorClass) {
        const el = document.getElementById('statusMsg');
        el.className = `mt-4 text-center text-sm font-medium ${colorClass}`;
        el.innerText = msg;
    }
</script>

</body>
</html>
